# Микросервис geoip_ms

Микросервис разработан на фреймворке Yii2 (php) в рамках выполнения небольшого тестового 
задания и обладает минимально полезной функциональностью, которую несложно расширить. 

__Краткое описание__

    Микросервис получает данные по http-протоколу методом POST в json-формате, вида {"ip": "8.8.8.8"}
    Возвращает ответ в формате json {"country_code": "US"}, либо данные об ошибке в том же формате.

__Особенности реализации__

Сервис получает данные обращением к внешнему сервису по API. Конфигурация API вынесена в конфигурационный файл, поэтому сервис можно легко перенстроить на другой источник.

Полученные данные сохраняются в кэш, что, теоретически, со временем, может снизить количество обращений к внешнему источнику.

Так как API установил лимит в 45 обращений в минуту, то реализован простой механизм предотвращения бана
при чрезмерно частом обращению к сервису. До обращения к внешнему api сервис в кэше выставляет семафор busy (метод add()). Если выставить не удается, то повторяем попытки
до достижения временного лимита, заданного в том же конфигурационном файле.
Выставление семафора означает, что именно этот экземпляр сервиса получил право монопольной работы с внешним API.

После этого из кэша извлекается время по второму специальному ключу "когда уже можно снова запросить внешний API".
После требуемой паузы запрашиваются данные, в кэш прописывается новое время, ранее которого нельзя обращаться к API.
И, снимается семафор, открывая возможность запроса следующему экземпляру.

__Технические моменты__

- Возвращаемые коды ошибок: 400 (на этапе получения и разбора запроса), 409 (на этапе подготовки ответа сервиса)
- Использован стандартный логгер, поэтому в лог-файл попадает не только краткая информация об ошибке, но и Stack trace
- Кэшатор можно легко заменить. Кроме манипуляций над конфиг-файлом стоит проверить/вспомнить наличие и логику метода add() 
в другом инструменте.
- Это мой первый опыт работы с Yii2)

__Запуск__

В папке appache2/sites-available создаем файл:

    geoip_ms.loc.conf

    <VirtualHost *:80>
    ServerName geoip_ms.loc
    DocumentRoot /__your_path_here__/geoip_ms/web
    <Directory /__your_path_here__/geoip_ms/web>

    RewriteEngine on

    # Если запрашиваемая в URL директория или файл существуют обращаемся к ним напрямую
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    # Если нет - перенаправляем запрос на index.php
    RewriteRule . index.php

        Options Indexes MultiViews FollowSymLinks
	AllowOverride All
	Require local
	#Order allow,deny
	#Allow from all
    </Directory>
</VirtualHost>

Добавляем в файл

    \etc\hosts

    строку localhost geoip_ms.loc

Создаем конфиг файл в папке appache2/sites-enabled командой

    a2ensite geoip_ms.loc

Перезапускаем apache2

После этого, микросервис доступен по http://geoip_ms.loc
Без настройки виртуального хоста доступ возможен через
http://localhost/geoip_ms/web/

Вызов из браузера - просмотр краткой информации об использовании
Для проверки работы сервиса можно использовать команду curl, например:

	curl -d '{"ip":"3.5.3.4"}' -H "Content-Type: application/json" -H "Accept:application/json" http://geoip_ms.loc


Released: 27/05/2022 - 31/05/2022
License: GPL











